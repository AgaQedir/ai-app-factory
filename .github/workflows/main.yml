name: AI App Factory (GPT)
on:
  workflow_dispatch:
    inputs:
      idea:
        description: 'App Idea'
        required: true
        default: 'Crypto Dashboard'
permissions:
  contents: write
jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-python@v4
        with: { python-version: '3.9' }
      
      - name: Install Libraries
        run: pip install openai

      - name: Generate App with GPT
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          PROMPT: ${{ inputs.idea }}
        run: |
          python -c "
          import os
          import sys
          from openai import OpenAI

          print('--- ğŸ§  GPT BEYNÄ° Ä°ÅÆ DÃœÅDÃœ ---')
          
          # 1. AÃ§arÄ± yoxlayÄ±rÄ±q
          api_key = os.environ.get('OPENAI_API_KEY')
          if not api_key:
              print('âŒ XÆTA: AÃ§ar tapÄ±lmadÄ±! AdÄ±nÄ± dÃ¼zgÃ¼n qoymusan?')
              sys.exit(1)

          client = OpenAI(api_key=api_key)

          # 2. GPT-yÉ™ É™mr veririk
          print(f'SorÄŸu: {os.environ["PROMPT"]}')
          
          system_prompt = '''You are an expert React & Next.js developer.
          Create a SINGLE FILE component (page.tsx).
          Use Tailwind CSS for styling. Use 'lucide-react' for icons.
          IMPORTANT: Wrap your code inside ---CLIENT--- and ---END--- tags.
          '''
          
          user_prompt = f'''Create a modern web page. 
          Topic: {os.environ["PROMPT"]}.
          Style: Dark mode, futuristic, professional.
          '''

          try:
              response = client.chat.completions.create(
                  model='gpt-4o-mini',
                  messages=[
                      {'role': 'system', 'content': system_prompt},
                      {'role': 'user', 'content': user_prompt}
                  ]
              )
              
              res = response.choices[0].message.content
              print('âœ… GPT Cavab Verdi!')

              if '---CLIENT---' in res:
                  code_content = res.split('---CLIENT---')[1].split('---END---')[0].strip()
              else:
                  # Ehtiyat variant
                  code_content = res.replace('```tsx', '').replace('```', '')

              # 3. FaylÄ± yazÄ±rÄ±q
              os.makedirs('app', exist_ok=True)
              with open('app/page.tsx', 'w', encoding='utf-8') as f:
                  f.write(code_content)
              
              # LazÄ±mi fayl
              pkg = '{\"name\":\"ai-app\",\"dependencies\":{\"next\":\"latest\",\"react\":\"latest\",\"react-dom\":\"latest\",\"lucide-react\":\"latest\"}}'
              with open('package.json', 'w', encoding='utf-8') as f:
                  f.write(pkg)
                  
              print('ğŸ‰ FAYLLAR HAZIRDIR!')

          except Exception as e:
              print(f'âŒ XÆTA OLDU: {e}')
              sys.exit(1)
          "

      - name: Save Code to GitHub
        run: |
          git config --global user.name 'AI Bot'
          git config --global user.email 'bot@ai.com'
          git add .
          git commit -m "New App Created by GPT"
          git push
