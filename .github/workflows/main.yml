on:
  workflow_dispatch:
    inputs:
      idea:
        description: 'App Idea'
        required: true
permissions:
  contents: write
jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-python@v4
        with: { python-version: '3.9' }
      - run: pip install google-generativeai
      - name: Generate
        env:
          KEY: ${{ secrets.GEMINI_API_KEY }}
          PROMPT: ${{ inputs.idea }}
        run: |
          python -c "
          import os, google.generativeai as g
          g.configure(api_key=os.environ['KEY'])
          model = g.GenerativeModel('gemini-1.5-flash')
          p = f'''Create Next.js app. User want: {os.environ['PROMPT']}. 
          If 3D needed use @react-three/fiber.
          Output format:
          ---CLIENT---
          (code)
          ---END---
          ---ADMIN---
          (code)
          ---END---'''
          try:
            res = model.generate_content(p).text
            c = res.split('---CLIENT---')[1].split('---END---')[0]
            a = res.split('---ADMIN---')[1].split('---END---')[0]
            os.makedirs('app/admin', exist_ok=True)
            with open('app/page.tsx','w') as f: f.write(c)
            with open('app/admin/page.tsx','w') as f: f.write(a)
            with open('package.json','w') as f: f.write('{\"name\":\"app\",\"dependencies\":{\"next\":\"latest\",\"react\":\"latest\",\"react-dom\":\"latest\",\"three\":\"latest\",\"@react-three/fiber\":\"latest\",\"@react-three/drei\":\"latest\"}}')
          except: pass"
      - run: |
          git config --global user.name 'Bot'
          git config --global user.email 'bot@x.com'
          git add .
          git commit -m "Done"
          git push
