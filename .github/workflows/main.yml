name: AI App Factory (FIXED)
on:
  workflow_dispatch:
    inputs:
      idea:
        description: 'App Idea'
        required: true
        default: 'Crypto Dashboard'
permissions:
  contents: write
jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-python@v4
        with: { python-version: '3.9' }
      
      - run: pip install openai

      - name: Generate App
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          PROMPT: ${{ inputs.idea }}
        run: |
          cat <<EOF > generator.py
          import os
          import sys
          from openai import OpenAI

          print('--- üõ†Ô∏è T∆èMƒ∞R BRƒ∞QADASI ƒ∞≈û∆è D√ú≈ûD√ú ---')

          api_key = os.environ.get('OPENAI_API_KEY')
          user_idea = os.environ.get('PROMPT')

          if not api_key:
              sys.exit(1)

          client = OpenAI(api_key=api_key)

          # 1. Kodu aliriq
          try:
              response = client.chat.completions.create(
                  model="gpt-4o-mini",
                  messages=[
                      {"role": "system", "content": "You are a Next.js expert. Output ONLY code inside ---CLIENT--- tags."},
                      {"role": "user", "content": f"Create a modern Next.js page (page.tsx) with Tailwind. Request: {user_idea}"}
                  ]
              )
              res = response.choices[0].message.content
              
              if "---CLIENT---" in res:
                  code = res.split("---CLIENT---")[1].split("---END---")[0].strip()
              else:
                  code = res.replace("```tsx", "").replace("```", "")

              os.makedirs("app", exist_ok=True)
              with open("app/page.tsx", "w", encoding="utf-8") as f:
                  f.write(code)

              # 2. VERCEL √ú√á√úN D√úZG√úN AYARLAR (Bura vacibdir!)
              # TypeScript ve lazimi kitabxanalari elave edirik
              pkg = '''{
                "name": "ai-app",
                "version": "1.0.0",
                "scripts": {
                  "dev": "next dev",
                  "build": "next build",
                  "start": "next start"
                },
                "dependencies": {
                  "next": "latest",
                  "react": "latest",
                  "react-dom": "latest",
                  "lucide-react": "latest",
                  "framer-motion": "latest",
                  "recharts": "latest"
                },
                "devDependencies": {
                  "typescript": "latest",
                  "@types/node": "latest",
                  "@types/react": "latest",
                  "@types/react-dom": "latest",
                  "postcss": "latest",
                  "tailwindcss": "latest"
                }
              }'''
              
              with open("package.json", "w", encoding="utf-8") as f:
                  f.write(pkg)
                  
              # 3. Tailwind Config (Dizayn u√ßmasƒ±n deye)
              tw_config = '''/** @type {import('tailwindcss').Config} */
              module.exports = {
                content: ["./app/**/*.{js,ts,jsx,tsx}", "./pages/**/*.{js,ts,jsx,tsx}", "./components/**/*.{js,ts,jsx,tsx}"],
                theme: { extend: {} },
                plugins: [],
              }'''
              with open("tailwind.config.js", "w", encoding="utf-8") as f:
                  f.write(tw_config)

              print("üéâ FAYLLAR TAM HAZIRDIR!")

          except Exception as e:
              print(f"XETA: {e}")
              sys.exit(1)
          EOF

          python generator.py

      - name: Save to GitHub
        run: |
          git config --global user.name 'Bot'
          git config --global user.email 'bot@ai.com'
          git add .
          git commit -m "Fixed Vercel Build Error"
          git push
